"use strict";(self.webpackChunksinnammanyo_cn=self.webpackChunksinnammanyo_cn||[]).push([[257],{56331:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>c,toc:()=>m});var n=a(87462),r=(a(67294),a(3905)),s=(a(83989),a(51007)),l=a(31937);const o={id:"cloud-tease-cat-danmu-hunter",title:"\u8fdc\u7a0b\u9017\u732b \u2014\u2014 \u5f39\u5e55\u4ea4\u4e92",sidebar_label:"B\u7ad9\u76f4\u64ad\u5f39\u5e55\u4ea4\u4e92"},i=void 0,c={unversionedId:"studio/\u4e91\u9017\u732b/cloud-tease-cat-danmu-hunter",id:"studio/\u4e91\u9017\u732b/cloud-tease-cat-danmu-hunter",title:"\u8fdc\u7a0b\u9017\u732b \u2014\u2014 \u5f39\u5e55\u4ea4\u4e92",description:"\u89c6\u9891\u6f14\u793a",source:"@site/docs/projects/studio/\u4e91\u9017\u732b/\u5b9e\u65f6\u5f39\u5e55\u4ea4\u4e92.md",sourceDirName:"studio/\u4e91\u9017\u732b",slug:"/studio/\u4e91\u9017\u732b/cloud-tease-cat-danmu-hunter",permalink:"/projects/studio/\u4e91\u9017\u732b/cloud-tease-cat-danmu-hunter",draft:!1,editUrl:"https://github.com/rcxxx/sinnammanyo.cn/tree/master/docs/projects/studio/\u4e91\u9017\u732b/\u5b9e\u65f6\u5f39\u5e55\u4ea4\u4e92.md",tags:[],version:"current",frontMatter:{id:"cloud-tease-cat-danmu-hunter",title:"\u8fdc\u7a0b\u9017\u732b \u2014\u2014 \u5f39\u5e55\u4ea4\u4e92",sidebar_label:"B\u7ad9\u76f4\u64ad\u5f39\u5e55\u4ea4\u4e92"},sidebar:"\ud83e\uddea projects",previous:{title:"\u667a\u969c\u5783\u573e\u6876",permalink:"/projects/studio/\u5783\u573e\u6876/foolish-trash-bin"},next:{title:"B\u7ad9\u76f4\u64ad\u5f39\u5e55\u4ea4\u4e92",permalink:"/projects/studio/\u4e91\u9017\u732b/cloud-tease-cat-danmu-hunter"}},p={},m=[{value:"\u89c6\u9891\u6f14\u793a",id:"\u89c6\u9891\u6f14\u793a",level:3},{value:"\u9879\u76ee\u5730\u5740",id:"\u9879\u76ee\u5730\u5740",level:3},{value:"Python aiowebsocket \u5b9e\u65f6\u83b7\u53d6\u5f39\u5e55\u6570\u636e",id:"python-aiowebsocket-\u5b9e\u65f6\u83b7\u53d6\u5f39\u5e55\u6570\u636e",level:2},{value:"\u4e0e B\u7ad9 \u76f4\u64ad\u670d\u52a1\u5668\u8fdb\u884c websocket \u8fde\u63a5",id:"\u4e0e-b\u7ad9-\u76f4\u64ad\u670d\u52a1\u5668\u8fdb\u884c-websocket-\u8fde\u63a5",level:3},{value:"\u5b9a\u65f6\u53d1\u9001\u5fc3\u8df3\u5305\uff0c\u4fdd\u6301\u8fde\u63a5",id:"\u5b9a\u65f6\u53d1\u9001\u5fc3\u8df3\u5305\u4fdd\u6301\u8fde\u63a5",level:3},{value:"\u63a5\u6536\u5e76\u89e3\u6790\u6570\u636e",id:"\u63a5\u6536\u5e76\u89e3\u6790\u6570\u636e",level:3},{value:"\u5b9a\u65f6\u5411\u4e32\u53e3\u53d1\u9001\u63a7\u5236\u4fe1\u606f",id:"\u5b9a\u65f6\u5411\u4e32\u53e3\u53d1\u9001\u63a7\u5236\u4fe1\u606f",level:3}],d={toc:m};function u(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)(s.Z,{mdxType:"BrowserWindow"},(0,r.kt)("h3",{id:"\u89c6\u9891\u6f14\u793a"},"\u89c6\u9891\u6f14\u793a"),(0,r.kt)(l.Z,{src:"//player.bilibili.com/player.html?aid=528488504&bvid=BV1eu41147ok&cid=1123471632&page=1",bsrc:"https://www.bilibili.com/video/BV1eu41147",mdxType:"BVideo"}),(0,r.kt)("h3",{id:"\u9879\u76ee\u5730\u5740"},"\u9879\u76ee\u5730\u5740"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("a",{parentName:"strong",href:"https://github.com/rcxxx/Cloud-Tease-Cat"},"rcxxx/Cloud-Tease-Cat"))))),(0,r.kt)("h2",{id:"python-aiowebsocket-\u5b9e\u65f6\u83b7\u53d6\u5f39\u5e55\u6570\u636e"},"Python aiowebsocket \u5b9e\u65f6\u83b7\u53d6\u5f39\u5e55\u6570\u636e"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},(0,r.kt)("a",{parentName:"em",href:"https://blog.csdn.net/Sharp486/article/details/122466308"},"AioWebSocket\u5b9e\u73b0python\u5f02\u6b65\u63a5\u6536B\u7ad9\u76f4\u64ad\u5f39\u5e55")))),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"AioWebSocket")," \u662f\u4e00\u4e2a\u652f\u6301\u5f02\u6b65\u64cd\u4f5c\u7684\u5e93\uff0c\u4f7f\u7528\u524d\u53ef\u4ee5\u5bf9 python \u7684\u5f02\u6b65\u5e93\u8fdb\u884c\u4e86\u89e3"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},(0,r.kt)("a",{parentName:"em",href:"https://docs.python.org/zh-cn/3.8/library/asyncio.html"},"asyncio --- \u5f02\u6b65 I/O")))),(0,r.kt)("h3",{id:"\u4e0e-b\u7ad9-\u76f4\u64ad\u670d\u52a1\u5668\u8fdb\u884c-websocket-\u8fde\u63a5"},"\u4e0e B\u7ad9 \u76f4\u64ad\u670d\u52a1\u5668\u8fdb\u884c websocket \u8fde\u63a5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-py"},"import asyncio\n\nfrom aiowebsocket.converses import AioWebSocket\n\nremote = 'ws://broadcastlv.chat.bilibili.com:2244/sub'\nroom_id = ''\n\ndata_raw = '000000{Header}0010000100000007000000017b22726f6f6d6964223a{ID}7d'\ndata_raw = data_raw.format(Header=hex(27 + len(room_id))[2:],\n                           ID=''.join(map(lambda x: hex(ord(x))[2:], list(room_id))))\nasync def startUp():\n    async with AioWebSocket(remote) as aws:\n        converse = aws.manipulator\n        await converse.send(bytes.fromhex(data_raw))\n        mes = await converse.receive()\n        print('Client receive: {}'.format(mes))\n\nif __name__ == '__main__':\n    try:\n        loop = asyncio.get_event_loop()\n        loop.run_until_complete(startUp())\n\n    except KeyboardInterrupt as exc:\n        print('Quit.')\n\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"room_id")," \u4e2d\u586b\u5165\u4f60\u60f3\u8981\u83b7\u53d6\u5f39\u5e55\u7684\u76f4\u64ad\u95f4ID")),(0,r.kt)("p",null,"\u7ec8\u7aef\u8f93\u51fa\u5982\u4e0b\uff0c\u6210\u529f\u63a5\u6536\u670d\u52a1\u5668\u6d88\u606f"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Client receive: b'\\x00\\x00\\x00\\x1a\\x00\\x10\\x00\\x01\\x00\\x00\\x00\\x08\\x00\\x00\\x00\\x01{\"code\":0}'\n")),(0,r.kt)("h3",{id:"\u5b9a\u65f6\u53d1\u9001\u5fc3\u8df3\u5305\u4fdd\u6301\u8fde\u63a5"},"\u5b9a\u65f6\u53d1\u9001\u5fc3\u8df3\u5305\uff0c\u4fdd\u6301\u8fde\u63a5"),(0,r.kt)("p",null,"\u5b9a\u4e49\u53d1\u9001\u5fc3\u8df3\u5305\u7684\u534f\u7a0b\u51fd\u6570"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-py"},"# \u5fc3\u8df3\u5305\u5185\u5bb9\nheart_beat_msg = '00 00 00 10 00 10 00 01  00 00 00 02 00 00 00 01'\n# \u53d1\u9001\u95f4\u9694\u65f6\u95f4\nsend_heart_beat_interval = 30\nasync def sendHeartBeat(_webscoket):\n    while True:\n        await asyncio.sleep(send_heart_beat_interval)\n        await _webscoket.send(bytes.fromhex(heart_beat_msg))\n        print('[Notice] Sent HeartBeat.')\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u5728\u4e8b\u4ef6\u5faa\u73af\u4e2d\u6dfb\u52a0\u5fc3\u8df3\u5305\u53d1\u9001\u4efb\u52a1")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-py"},"async def startUp():\n    async with AioWebSocket(remote) as aws:\n        converse = aws.manipulator\n        await converse.send(bytes.fromhex(data_raw))\n        mes = await converse.receive()\n        print('Client receive: {}'.format(mes))\n        task = asyncio.create_task(sendHeartBeat(converse))\n        await asyncio.wait({task})\n")),(0,r.kt)("p",null,"\u6267\u884c\u540e\uff0c\u6bcf\u95f4\u9694 30s \u90fd\u4f1a\u5411\u670d\u52a1\u5668\u53d1\u9001\u5fc3\u8df3\u5305\uff0c\u7ef4\u6301\u8fde\u63a5"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://pictures-1304295136.cos.ap-guangzhou.myqcloud.com/screenshot/cloud-tease-cat/sendHeartBeat.png",alt:null})),(0,r.kt)("h3",{id:"\u63a5\u6536\u5e76\u89e3\u6790\u6570\u636e"},"\u63a5\u6536\u5e76\u89e3\u6790\u6570\u636e"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-py"},"async def receivePackage(_webscoket):\n    while True:\n        recv_text = await _webscoket.receive()\n\n        if recv_text == None:\n            recv_text = b'\\x00\\x00\\x00\\x1a\\x00\\x10\\x00\\x01\\x00\\x00\\x00\\x08\\x00\\x00\\x00\\x01{\"code\":0}'\n\n        parseData(recv_text)\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"recv_text \u8fd4\u56de\u7684\u6570\u636e\u5305\u53ef\u80fd\u4e3a\u7a7a\uff0c\u8fd9\u65f6\u5019\u5c31\u9700\u8981\u624b\u52a8\u8bbe\u7f6e\u4e3a\u8fde\u63a5\u6210\u529f\u65f6\u8fd4\u56de\u7684\u6570\u636e\u5305")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-py"},"import json\nimport zlib\n\ndef parseData(_data):\n    # \u83b7\u53d6\u6570\u636e\u5305\u7684\u957f\u5ea6\uff0c\u7248\u672c\u548c\u64cd\u4f5c\u7c7b\u578b\n    packet_len = int(_data[:4].hex(), 16)\n    ver = int(_data[6:8].hex(), 16)\n    op = int(_data[8:12].hex(), 16)\n\n    if (len(_data) > packet_len):\n        parseData(_data[packet_len:])\n        _data = _data[:packet_len]\n    if (ver == 2):\n        _data = zlib.decompress(_data[16:])\n        parseData(_data)\n        return\n    if (ver == 1):\n        return\n\n    if (op == 5):\n        global status_counter\n        try:\n            jd = json.loads(_data[16:].decode('utf-8', errors='ignore'))\n            if (jd['cmd'] == 'DANMU_MSG'):\n                msg = jd['info'][1]\n                user = jd['info'][2][1]\n                print(\"[DANMU_MSG]:   User: {}  Msg: {}\".format(user, msg))\n        except Exception as e:\n            pass\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u9700\u8981\u6570\u636e\u7684\u54ea\u4e2a\u5b57\u6bb5\uff0c\u5c31\u5728\u6570\u636e\u5305\u4e2d\u83b7\u53d6\u54ea\u4e2a\u5b57\u6bb5\uff0c\u8fd9\u91cc\u53ea\u9700\u8981\u5f39\u5e55\u6570\u636e\uff0c\u5373 ",(0,r.kt)("inlineCode",{parentName:"li"},"DANMU_MSG")," \u5b57\u6bb5")),(0,r.kt)("p",null,"\u5bf9\u5e94\u5b57\u6bb5\u4fe1\u606f\u53ef\u4ee5\u53c2\u8003"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},(0,r.kt)("a",{parentName:"em",href:"https://github.com/lovelyyoshino/Bilibili-Live-API/blob/master/API.WebSocket.md"},"lovelyyoshino/Bilibili-Live-API/API.WebSocket.md")))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u5728\u4e8b\u4ef6\u5faa\u73af\u4e2d\u6dfb\u52a0\u6570\u636e\u63a5\u6536\u4efb\u52a1")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-py"},"async def startUp():\n    async with AioWebSocket(remote) as aws:\n        converse = aws.manipulator\n        await converse.send(bytes.fromhex(data_raw))\n        mes = await converse.receive()\n        print('Client receive: {}'.format(mes))\n        task_heart_beat = asyncio.create_task(sendHeartBeat(converse))\n        task_receive_package = asyncio.create_task(receivePackage(converse))\n        await asyncio.wait({task_heart_beat, task_receive_package})\n\n")),(0,r.kt)("p",null,"\u5b9e\u65f6\u63a5\u6536\u5f39\u5e55\u6d88\u606f"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://pictures-1304295136.cos.ap-guangzhou.myqcloud.com/screenshot/cloud-tease-cat/receivePackage.png",alt:null})),(0,r.kt)("h3",{id:"\u5b9a\u65f6\u5411\u4e32\u53e3\u53d1\u9001\u63a7\u5236\u4fe1\u606f"},"\u5b9a\u65f6\u5411\u4e32\u53e3\u53d1\u9001\u63a7\u5236\u4fe1\u606f"),(0,r.kt)("p",null,"\u88ab\u63a7\u5236\u7684\u5404\u73a9\u5177\u7ec8\u7aef\u9700\u8981\u4e00\u5b9a\u7684\u6267\u884c\u65f6\u95f4\uff0c\u4e0d\u80fd\u6bcf\u6536\u5230\u4e00\u6b21\u5f39\u5e55\u6d88\u606f\u5c31\u53d1\u9001\u4e00\u6b21\u63a7\u5236\u4fe1\u606f\uff0c\u91c7\u7528\u8ba1\u6570\u5f62\u5f0f\uff0c\u6bcf\u6536\u5230\u4e00\u79cd\u79cd\u7c7b\u7684\u5f39\u5e55\u4fe1\u606f\u540e\u8fdb\u884c\u8ba1\u6570\uff0c\u4e00\u5b9a\u540e\u5bf9\u8ba1\u6570\u6700\u591a\u7684\u73a9\u5177\u7c7b\u578b\u6267\u884c\u63a7\u5236"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u521b\u5efa\u8ba1\u6570\u5668\uff0c\u4fee\u6539\u89e3\u6790\u51fd\u6570\uff0c\u5bf9\u8ba1\u6570\u5668\u6267\u884c\u7d2f\u52a0")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-py"},"KEYS = {'\u5c0f\u7403':[0xA5, 0xA5, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00],\n        '\u6fc0\u5149\u7b14':[0xA5, 0xA5, 0x05, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00],\n        '\u9017\u732b\u68d2':[0xA5, 0xA5, 0x09, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00]}\n\nstatus_counter = {'\u5c0f\u7403':0,\n                  '\u6fc0\u5149\u7b14':0,\n                  '\u9017\u732b\u68d2':0}\n\ndef parseData(_data):\n    # \u83b7\u53d6\u6570\u636e\u5305\u7684\u957f\u5ea6\uff0c\u7248\u672c\u548c\u64cd\u4f5c\u7c7b\u578b\n    ...\n\n    if (op == 5):\n        global status_counter\n        try:\n            jd = json.loads(_data[16:].decode('utf-8', errors='ignore'))\n            if (jd['cmd'] == 'DANMU_MSG'):\n                msg = jd['info'][1]\n                user = jd['info'][2][1]\n                print(\"[DANMU_MSG]:   User: {}  Msg: {}\".format(user, msg))\n                if msg in KEYS.keys():\n                    status_counter[msg] += 1\n\n        except Exception as e:\n            pass\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"KEYS = {}")," \u4e3a\u81ea\u5b9a\u4e49\u7684\u63a7\u5236\u4fe1\u606f")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u4e32\u53e3\u5b9a\u65f6\u4efb\u52a1")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-py"},"def statusWrite():\n    global status_counter\n    max_p = max(zip(status_counter.values(), status_counter.keys()))\n    if max_p[0] > 0:\n        data = KEYS[max_p[1]]\n        ser.write(bytes(data))\n        print(\"\\033[0;;42m[Publisher]\\033[0m:   Use item: \", max_p[1], \"  \\033[0;36m[Counter]\\033[0m: Clear\")\n    else:\n        print(\"\\033[0;;41m[Publisher]\\033[0m:   No items are selected.  \\033[0;36m[Counter]\\033[0m: Clear\")\n    # \u6bcf\u6b21\u53d1\u9001\u63a7\u5236\u4fe1\u606f\u540e\u5c06\u8ba1\u6570\u5668\u6e05\u96f6\n    status_counter = {'\u5c0f\u7403':0, '\u6fc0\u5149\u7b14':0, '\u9017\u732b\u68d2':0}\n\nSER_WRITE_INTERVAL = 10\nasync def intervalSend():\n    global status_counter\n    while True:\n        await asyncio.sleep(SER_WRITE_INTERVAL)\n        statusWrite()\n")),(0,r.kt)("p",null,"\u6267\u884c\u6548\u679c\n",(0,r.kt)("img",{parentName:"p",src:"https://pictures-1304295136.cos.ap-guangzhou.myqcloud.com/screenshot/cloud-tease-cat/run-result.png",alt:null})))}u.isMDXComponent=!0},31937:(e,t,a)=>{a.d(t,{Z:()=>i});var n=a(67294),r=a(45697),s=a.n(r);const l="videoFrame_DuF0";function o(e){let{src:t,bsrc:a}=e;return n.createElement(n.Fragment,null,n.createElement("iframe",{src:t,loading:"lazy",scrolling:"no",border:0,frameBorder:"no",framespacing:0,allowFullScreen:!0,className:l}))}o.propTypes={src:s().string.isRequired,bsrc:s().string};const i=o},51007:(e,t,a)=>{a.d(t,{Z:()=>d});var n=a(67294);const r="browserWindow_my1Q",s="browserWindowHeader_jXSR",l="buttons_uHc7",o="browserWindowAddressBar_Pd8y",i="dot_giz1",c="browserWindowMenuIcon_Vhuh",p="bar_rrRL",m="browserWindowBody_Idgs";const d=function(e){let{children:t,minHeight:a,url:d}=e;return n.createElement("div",{className:r,style:{minHeight:a}},n.createElement("div",{className:s},n.createElement("div",{className:l},n.createElement("span",{className:i,style:{background:"#f25f58"}}),n.createElement("span",{className:i,style:{background:"#fbbe3c"}}),n.createElement("span",{className:i,style:{background:"#58cb42"}})),n.createElement("div",{className:o},d),n.createElement("div",{className:c},n.createElement("div",null,n.createElement("span",{className:p}),n.createElement("span",{className:p}),n.createElement("span",{className:p})))),n.createElement("div",{className:m},t))}}}]);