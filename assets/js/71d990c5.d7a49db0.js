"use strict";(self.webpackChunksinnammanyo_cn=self.webpackChunksinnammanyo_cn||[]).push([[3690],{31937:(e,t,a)=>{a.d(t,{Z:()=>c});var n=a(67294),r=a(45697),s=a.n(r);const o="videoFrame_DuF0";function l(e){let{src:t,bsrc:a}=e;return n.createElement(n.Fragment,null,n.createElement("iframe",{src:t,loading:"lazy",scrolling:"no",border:0,frameBorder:"no",framespacing:0,allowFullScreen:!0,className:o}))}l.propTypes={src:s().string.isRequired,bsrc:s().string};const c=l},51007:(e,t,a)=>{a.d(t,{Z:()=>p});var n=a(67294);const r="browserWindow_my1Q",s="browserWindowHeader_jXSR",o="buttons_uHc7",l="browserWindowAddressBar_Pd8y",c="dot_giz1",i="browserWindowMenuIcon_Vhuh",d="bar_rrRL",m="browserWindowBody_Idgs";const p=function(e){let{children:t,minHeight:a,url:p}=e;return n.createElement("div",{className:r,style:{minHeight:a}},n.createElement("div",{className:s},n.createElement("div",{className:o},n.createElement("span",{className:c,style:{background:"#f25f58"}}),n.createElement("span",{className:c,style:{background:"#fbbe3c"}}),n.createElement("span",{className:c,style:{background:"#58cb42"}})),n.createElement("div",{className:l},p),n.createElement("div",{className:i},n.createElement("div",null,n.createElement("span",{className:d}),n.createElement("span",{className:d}),n.createElement("span",{className:d})))),n.createElement("div",{className:m},t))}},67016:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>d,contentTitle:()=>c,default:()=>u,frontMatter:()=>l,metadata:()=>i,toc:()=>m});var n=a(87462),r=(a(67294),a(3905)),s=(a(83989),a(51007)),o=a(31937);const l={id:"cloud-tease-cat-danmu-hunter",title:"\u8fdc\u7a0b\u9017\u732b \u2014\u2014 \u5f39\u5e55\u4ea4\u4e92",sidebar_label:"B\u7ad9\u76f4\u64ad\u5f39\u5e55\u4ea4\u4e92"},c=void 0,i={unversionedId:"project/studio/\u4e91\u9017\u732b/cloud-tease-cat-danmu-hunter",id:"project/studio/\u4e91\u9017\u732b/cloud-tease-cat-danmu-hunter",title:"\u8fdc\u7a0b\u9017\u732b \u2014\u2014 \u5f39\u5e55\u4ea4\u4e92",description:"\u89c6\u9891\u6f14\u793a",source:"@site/docs/docs/project/studio/\u4e91\u9017\u732b/\u5b9e\u65f6\u5f39\u5e55\u4ea4\u4e92.md",sourceDirName:"project/studio/\u4e91\u9017\u732b",slug:"/project/studio/\u4e91\u9017\u732b/cloud-tease-cat-danmu-hunter",permalink:"/docs/project/studio/\u4e91\u9017\u732b/cloud-tease-cat-danmu-hunter",draft:!1,editUrl:"https://github.com/rcxxx/sinnammanyo.cn/tree/master/docs/docs/project/studio/\u4e91\u9017\u732b/\u5b9e\u65f6\u5f39\u5e55\u4ea4\u4e92.md",tags:[],version:"current",frontMatter:{id:"cloud-tease-cat-danmu-hunter",title:"\u8fdc\u7a0b\u9017\u732b \u2014\u2014 \u5f39\u5e55\u4ea4\u4e92",sidebar_label:"B\u7ad9\u76f4\u64ad\u5f39\u5e55\u4ea4\u4e92"},sidebar:"\ud83d\udcafproject",previous:{title:"\u667a\u969c\u5783\u573e\u6876",permalink:"/docs/project/studio/\u5783\u573e\u6876/foolish-trash-bin"},next:{title:"B\u7ad9\u76f4\u64ad\u5f39\u5e55\u4ea4\u4e92",permalink:"/docs/project/studio/\u4e91\u9017\u732b/cloud-tease-cat-danmu-hunter"}},d={},m=[{value:"\u89c6\u9891\u6f14\u793a",id:"\u89c6\u9891\u6f14\u793a",level:3},{value:"\u9879\u76ee\u5730\u5740",id:"\u9879\u76ee\u5730\u5740",level:3},{value:"Python aiowebsocket \u5b9e\u65f6\u83b7\u53d6\u5f39\u5e55\u6570\u636e",id:"python-aiowebsocket-\u5b9e\u65f6\u83b7\u53d6\u5f39\u5e55\u6570\u636e",level:2},{value:"\u4e0e B\u7ad9 \u76f4\u64ad\u670d\u52a1\u5668\u8fdb\u884c websocket \u8fde\u63a5",id:"\u4e0e-b\u7ad9-\u76f4\u64ad\u670d\u52a1\u5668\u8fdb\u884c-websocket-\u8fde\u63a5",level:3},{value:"\u5b9a\u65f6\u53d1\u9001\u5fc3\u8df3\u5305\uff0c\u4fdd\u6301\u8fde\u63a5",id:"\u5b9a\u65f6\u53d1\u9001\u5fc3\u8df3\u5305\u4fdd\u6301\u8fde\u63a5",level:3},{value:"\u63a5\u6536\u5e76\u89e3\u6790\u6570\u636e",id:"\u63a5\u6536\u5e76\u89e3\u6790\u6570\u636e",level:3}],p={toc:m};function u(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)(s.Z,{mdxType:"BrowserWindow"},(0,r.kt)("h3",{id:"\u89c6\u9891\u6f14\u793a"},"\u89c6\u9891\u6f14\u793a"),(0,r.kt)(o.Z,{src:"",bsrc:"",mdxType:"BVideo"}),(0,r.kt)("h3",{id:"\u9879\u76ee\u5730\u5740"},"\u9879\u76ee\u5730\u5740")),(0,r.kt)("h2",{id:"python-aiowebsocket-\u5b9e\u65f6\u83b7\u53d6\u5f39\u5e55\u6570\u636e"},"Python aiowebsocket \u5b9e\u65f6\u83b7\u53d6\u5f39\u5e55\u6570\u636e"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},(0,r.kt)("a",{parentName:"em",href:"https://blog.csdn.net/Sharp486/article/details/122466308"},"AioWebSocket\u5b9e\u73b0python\u5f02\u6b65\u63a5\u6536B\u7ad9\u76f4\u64ad\u5f39\u5e55")))),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"AioWebSocket")," \u662f\u4e00\u4e2a\u652f\u6301\u5f02\u6b65\u64cd\u4f5c\u7684\u5e93\uff0c\u4f7f\u7528\u524d\u53ef\u4ee5\u5bf9 python \u7684\u5f02\u6b65\u5e93\u8fdb\u884c\u4e86\u89e3"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},(0,r.kt)("a",{parentName:"em",href:"https://docs.python.org/zh-cn/3.8/library/asyncio.html"},"asyncio --- \u5f02\u6b65 I/O")))),(0,r.kt)("h3",{id:"\u4e0e-b\u7ad9-\u76f4\u64ad\u670d\u52a1\u5668\u8fdb\u884c-websocket-\u8fde\u63a5"},"\u4e0e B\u7ad9 \u76f4\u64ad\u670d\u52a1\u5668\u8fdb\u884c websocket \u8fde\u63a5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-py"},"import asyncio\n\nfrom aiowebsocket.converses import AioWebSocket\n\nremote = 'ws://broadcastlv.chat.bilibili.com:2244/sub'\nroom_id = ''\n\ndata_raw = '000000{Header}0010000100000007000000017b22726f6f6d6964223a{ID}7d'\ndata_raw = data_raw.format(Header=hex(27 + len(room_id))[2:],\n                           ID=''.join(map(lambda x: hex(ord(x))[2:], list(room_id))))\nasync def startUp():\n    async with AioWebSocket(remote) as aws:\n        converse = aws.manipulator\n        await converse.send(bytes.fromhex(data_raw))\n        mes = await converse.receive()\n        print('Client receive: {}'.format(mes))\n\nif __name__ == '__main__':\n    try:\n        loop = asyncio.get_event_loop()\n        loop.run_until_complete(startUp())\n\n    except KeyboardInterrupt as exc:\n        print('Quit.')\n\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"room_id")," \u4e2d\u586b\u5165\u4f60\u60f3\u8981\u83b7\u53d6\u5f39\u5e55\u7684\u76f4\u64ad\u95f4ID")),(0,r.kt)("p",null,"\u7ec8\u7aef\u8f93\u51fa\u5982\u4e0b\uff0c\u6210\u529f\u63a5\u6536\u670d\u52a1\u5668\u6d88\u606f"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Client receive: b'\\x00\\x00\\x00\\x1a\\x00\\x10\\x00\\x01\\x00\\x00\\x00\\x08\\x00\\x00\\x00\\x01{\"code\":0}'\n")),(0,r.kt)("h3",{id:"\u5b9a\u65f6\u53d1\u9001\u5fc3\u8df3\u5305\u4fdd\u6301\u8fde\u63a5"},"\u5b9a\u65f6\u53d1\u9001\u5fc3\u8df3\u5305\uff0c\u4fdd\u6301\u8fde\u63a5"),(0,r.kt)("p",null,"\u5b9a\u4e49\u53d1\u9001\u5fc3\u8df3\u5305\u7684\u534f\u7a0b\u51fd\u6570"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-py"},"# \u5fc3\u8df3\u5305\u5185\u5bb9\nheart_beat_msg = '00 00 00 10 00 10 00 01  00 00 00 02 00 00 00 01'\n# \u53d1\u9001\u95f4\u9694\u65f6\u95f4\nsend_heart_beat_interval = 30\nasync def sendHeartBeat(_webscoket):\n    while True:\n        await asyncio.sleep(send_heart_beat_interval)\n        await _webscoket.send(bytes.fromhex(heart_beat_msg))\n        print('[Notice] Sent HeartBeat.')\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u5728\u4e8b\u4ef6\u5faa\u73af\u4e2d\u6dfb\u52a0\u5fc3\u8df3\u5305\u53d1\u9001\u4efb\u52a1")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-py"},"async def startUp():\n    async with AioWebSocket(remote) as aws:\n        converse = aws.manipulator\n        await converse.send(bytes.fromhex(data_raw))\n        mes = await converse.receive()\n        print('Client receive: {}'.format(mes))\n        task = asyncio.create_task(sendHeartBeat(converse))\n        await asyncio.wait({task})\n")),(0,r.kt)("p",null,"\u6267\u884c\u540e\uff0c\u6bcf\u95f4\u9694 30s \u90fd\u4f1a\u5411\u670d\u52a1\u5668\u53d1\u9001\u5fc3\u8df3\u5305\uff0c\u7ef4\u6301\u8fde\u63a5"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://pictures-1304295136.cos.ap-guangzhou.myqcloud.com/screenshot/cloud-tease-cat/sendHeartBeat.png",alt:null})),(0,r.kt)("h3",{id:"\u63a5\u6536\u5e76\u89e3\u6790\u6570\u636e"},"\u63a5\u6536\u5e76\u89e3\u6790\u6570\u636e"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-py"},"async def receivePackage(_webscoket):\n    while True:\n        recv_text = await _webscoket.receive()\n\n        if recv_text == None:\n            recv_text = b'\\x00\\x00\\x00\\x1a\\x00\\x10\\x00\\x01\\x00\\x00\\x00\\x08\\x00\\x00\\x00\\x01{\"code\":0}'\n\n        parseData(recv_text)\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"recv_text \u8fd4\u56de\u7684\u6570\u636e\u5305\u53ef\u80fd\u4e3a\u7a7a\uff0c\u8fd9\u65f6\u5019\u5c31\u9700\u8981\u624b\u52a8\u8bbe\u7f6e\u4e3a\u8fde\u63a5\u6210\u529f\u65f6\u8fd4\u56de\u7684\u6570\u636e\u5305")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-py"},"import json\nimport zlib\n\ndef parseData(_data):\n    # \u83b7\u53d6\u6570\u636e\u5305\u7684\u957f\u5ea6\uff0c\u7248\u672c\u548c\u64cd\u4f5c\u7c7b\u578b\n    packet_len = int(_data[:4].hex(), 16)\n    ver = int(_data[6:8].hex(), 16)\n    op = int(_data[8:12].hex(), 16)\n\n    if (len(_data) > packet_len):\n        parseData(_data[packet_len:])\n        _data = _data[:packet_len]\n    if (ver == 2):\n        _data = zlib.decompress(_data[16:])\n        parseData(_data)\n        return\n    if (ver == 1):\n        return\n\n    if (op == 5):\n        global status_counter\n        try:\n            jd = json.loads(_data[16:].decode('utf-8', errors='ignore'))\n            if (jd['cmd'] == 'DANMU_MSG'):\n                msg = jd['info'][1]\n                user = jd['info'][2][1]\n                print(\"[DANMU_MSG]:   User: {}  Msg: {}\".format(user, msg))\n        except Exception as e:\n            pass\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u9700\u8981\u6570\u636e\u7684\u54ea\u4e2a\u5b57\u6bb5\uff0c\u5c31\u5728\u6570\u636e\u5305\u4e2d\u83b7\u53d6\u54ea\u4e2a\u5b57\u6bb5\uff0c\u8fd9\u91cc\u53ea\u9700\u8981\u5f39\u5e55\u6570\u636e\uff0c\u5373 ",(0,r.kt)("inlineCode",{parentName:"li"},"DANMU_MSG")," \u5b57\u6bb5")),(0,r.kt)("p",null,"\u5bf9\u5e94\u5b57\u6bb5\u4fe1\u606f\u53ef\u4ee5\u53c2\u8003"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},(0,r.kt)("a",{parentName:"em",href:"https://github.com/lovelyyoshino/Bilibili-Live-API/blob/master/API.WebSocket.md"},"lovelyyoshino/Bilibili-Live-API/API.WebSocket.md")))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u5728\u4e8b\u4ef6\u5faa\u73af\u4e2d\u6dfb\u52a0\u6570\u636e\u63a5\u6536\u4efb\u52a1")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-py"},"async def startUp():\n    async with AioWebSocket(remote) as aws:\n        converse = aws.manipulator\n        await converse.send(bytes.fromhex(data_raw))\n        mes = await converse.receive()\n        print('Client receive: {}'.format(mes))\n        task_heart_beat = asyncio.create_task(sendHeartBeat(converse))\n        task_receive_package = asyncio.create_task(receivePackage(converse))\n        await asyncio.wait({task_heart_beat, task_receive_package})\n\n")),(0,r.kt)("p",null,"\u5b9e\u65f6\u63a5\u6536\u5f39\u5e55\u6d88\u606f"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://pictures-1304295136.cos.ap-guangzhou.myqcloud.com/screenshot/cloud-tease-cat/receivePackage.png",alt:null})))}u.isMDXComponent=!0}}]);